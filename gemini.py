import requests
from score_calculation import *

# =========================
# Gemini RAG 컨텍스트
#  + 유사고객 리뷰 3건 포함
# =========================
def build_rag_context(reco_list):
    ctx_blocks = []

    for item in reco_list:
        p = item["product"]
        b = item["brand"]

        hw_pos = ", ".join(list(p["hwahae"]["positive"].keys())[:5])
        hw_neg = ", ".join(list(p["hwahae"]["negative"].keys())[:5])

        similar_reviews = "\n".join(
            [f"- {r['review_text']} (★{r['overall_rating']})"
             for r in item["similar_reviews"]]
        )

        block = f"""
[브랜드]
- {b["brand_name"]}
- CRM 톤: {b["crm_tone"]}
- 메시지 목적: {b["crm_purpose"]}

[제품]
- 제품명: {p["product_name"]}
- 특징 태그: {", ".join(p["tags"])}
- 기획상품 여부: {"기획상품" if p["is_planning_product"] else "일반상품"}

[제품 설명 프롬프트]
{p["feature_prompt_text"]}

[화해 긍정 키워드] {hw_pos}
[화해 부정 키워드] {hw_neg}

[고객님과 유사한 사용자는 이런 평가를 남겼습니다]
{similar_reviews}
"""
        ctx_blocks.append(block)

    return "\n\n--------------------\n\n".join(ctx_blocks)


# =========================
# Gemini 메시지 생성
# =========================
def generate_marketing_message(context, customer):

    prompt = f"""
당신은 아모레몰 CRM 개인화 추천 카피라이팅 AI입니다.
출력되는 메시지는 실제 고객에게 발송되는 CRM 개인화 추천 메시지입니다.

메시지 톤과 목적은 각 제품의 브랜드 CRM 전략을 따르되,
고객의 연령대와 성별에 맞춘 말투/어조를 사용하세요.

[고객 기본 정보]
- 연령대: {customer["age_group"]}
- 성별: {customer["gender"]}

[추천 제품 + CRM 컨텍스트]
{context}

작성 형식:

- 각 제품은
  • 짧은 헤드라인 1문장
  • 베네핏 중심 소개 2~3문장
  • 유사고객 리뷰 근거 1문단
  • 추천 결론 1문장
  의 흐름으로 작성하되,
  절대 번호(①②③④ / 1) 2) / 제목 헤더 등)를 출력하지 마세요.
  문단 사이에 번호·라벨 없이 자연스러운 단락으로만 작성하세요.

========================
메시지 분량 제한 (필수 준수)
========================
- 헤드라인(제목)은 40자 이내로 작성하세요.
- 본문 전체 분량(소개·리뷰 근거·추천 결론 포함)은 350자 이내로 작성하세요.
- 분량 제한을 넘기지 않도록 간결하게 작성하세요.

유사고객 리뷰 문단은 아래 형식으로만 작성하세요.
- 문장 안에서 자연스럽게 연결해 작성하고,
- 다음 형태를 반드시 사용하세요:

  "고객님과 유사한 사용자는 ~~라고 평가했어요."

- “이렇게 평가했어요 / 다음과 같이 / 목록·불릿” 등은 사용하지 마세요.
- 2~3개의 리뷰 인사이트를 한 문단에 요약해 서술하세요.

추천 결론 문장은 아래 중 하나로 마무리하세요.
- "이런 이유로 고객님께 추천드립니다."
- "이런 점에서 고객님의 일상 루틴에 잘 어울려 추천드립니다."

스타일 가이드:
- 과장·단정·의학적/효능 표현 금지
- 수치·스펙 나열 최소화
- 이모지/과도한 감탄표현 사용 금지
- 기획상품은 사실 기반으로만 간단히 언급

========================
연령대/성별에 따른 말투 규칙
========================

[10대 여성]
- 밝고 부드럽지만 과도한 유행어·반말 금지
- “가볍게 사용하기 좋아요”, “일상에서 부담 없이 사용할 수 있어요”와 같은 말투

[20~30대 여성]
- 세련되고 차분한 톤, 실용적 가치 강조
- “일상 메이크업에 자연스럽게 어울려요”, “사용감에 만족도가 높아요”와 같은 표현

[40대 이상 여성]
- 배려 있고 정중한 톤, 피부 컨디션과 편안함 중심
- “부담 없이 편안하게 사용하실 수 있어요”와 같은 표현

[20~40대 남성]
- 간결하고 실용적인 톤, 기능적 이점 중심
- “일상에서 간편하게 사용하기 좋습니다”, “깔끔한 사용감을 선호하는 분께 적합합니다”

[10대 남성]
- 심플하고 직관적인 표현, 과장 금지
- “가볍게 사용하기 좋습니다”, “필요한 부분에만 자연스럽게 사용하기 좋습니다”

공통 규칙:
- 존칭 중심 문장 (“~하세요”, “~입니다”)
- 고객을 특정 집단/성 역할로 일반화하지 말 것
- 연령대·성별에 대한 추정/해석을 추가로 서술하지 말 것

제품별로 구분해 작성하되,
각 제품 내에서는 번호·머리글 없이 자연스러운 문장형 단락으로만 작성하세요.
"""




    print("==================================프롬프트==================================")
    print(prompt)
    print("===========================================================================")
    payload = {"contents":[{"parts":[{"text": prompt}]}]}

    res = requests.post(
        f"{GEMINI_ENDPOINT}?key={GEMINI_API_KEY}",
        headers={"Content-Type": "application/json"},
        json=payload,
    )
    res.raise_for_status()

    return res.json()["candidates"][0]["content"]["parts"][0]["text"]