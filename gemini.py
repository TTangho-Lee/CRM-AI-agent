import requests
from score_calculation import *

# =========================
# Gemini RAG 컨텍스트
#  + 유사고객 리뷰 3건 포함
# =========================
def build_rag_context(reco_list):
    ctx_blocks = []

    for item in reco_list:
        p = item["product"]
        b = item["brand"]

        hw_pos = ", ".join(list(p["hwahae"]["positive"].keys())[:5])
        hw_neg = ", ".join(list(p["hwahae"]["negative"].keys())[:5])

        similar_reviews = "\n".join(
            [f"- {r['review_text']} (★{r['overall_rating']})"
             for r in item["similar_reviews"]]
        )

        block = f"""
[브랜드]
- {b["brand_name"]}
- CRM 톤: {b["crm_tone"]}
- 메시지 목적: {b["crm_purpose"]}

[제품]
- 제품명: {p["product_name"]}
- 특징 태그: {", ".join(p["tags"])}
- 기획상품 여부: {"기획상품" if p["is_planning_product"] else "일반상품"}

[제품 설명 프롬프트]
{p["feature_prompt_text"]}

[화해 긍정 키워드] {hw_pos}
[화해 부정 키워드] {hw_neg}

[고객님과 유사한 사용자는 이런 평가를 남겼습니다]
{similar_reviews}
"""
        ctx_blocks.append(block)

    return "\n\n--------------------\n\n".join(ctx_blocks)


# =========================
# Gemini 메시지 생성
# =========================
def generate_marketing_message(context, customer):

    prompt = f"""
당신은 아모레몰 CRM 개인화 추천 카피라이팅 AI입니다.
출력되는 메시지는 실제 고객에게 발송되는 CRM 개인화 추천 메시지입니다.

메시지 톤과 목적은 각 제품의 브랜드 CRM 전략을 따르되,
고객의 연령대와 성별에 맞춘 말투/어조를 사용하세요.

[고객 기본 정보]
- 이름: {customer["user_name"]}
- 연령대: {customer["age_group"]}
- 성별: {customer["gender"]}
- 국적: {customer.get("nationality", "미기재")}

[추천 제품 + CRM 컨텍스트]
{context}

작성 형식:

- 각 제품은
  • 짧은 헤드라인 1문장
  • 베네핏 중심 소개 2~3문장
  • 유사고객 리뷰 근거 1문단
  • 추천 결론 1문장
  의 자연스러운 흐름으로 작성하세요.

- 절대 사용하지 말 것:
  • 번호(①②③④ / 1) 2) / Step / Header)
  • 섹션 제목 / 중간 소제목 / 구분 라벨
  • 글머리표 / 목록 / 불릿

문단은 번호·라벨 없이
자연스러운 문장 단락으로만 작성하세요.


========================
메시지 분량 제한 (필수 준수)
========================
- 헤드라인(제목)은 40자 이내로 작성하세요.
- 본문 전체 분량(소개·리뷰 근거·추천 결론 포함)은 350자 이내로 작성하세요.
- 분량 제한을 넘기지 않도록 간결하게 작성하세요.


========================
유사고객 리뷰 문단 규칙 (필수)
========================

- 반드시 아래 문장 구조를 사용하세요:

  "고객님과 유사한 사용자는 ~~라고 평가했어요."

- “이렇게 평가했어요 / 다음과 같이 / 목록 / 불릿” 표현 금지
- 리뷰 2~3개의 내용을 한 문단으로 자연스럽게 요약하세요.
- 과도한 인용·직접 리뷰 인용 금지


========================
추천 결론 문장 규칙
========================

마지막 문장은 아래 중 하나로만 마무리하세요.

- "이런 이유로 고객님께 추천드립니다."
- "이런 점에서 고객님의 일상 루틴에 잘 어울려 추천드립니다."


========================
스타일 가이드
========================
- 과장/확정적 효능/임상 표현 금지
- 의학적 표현, 치료/개선 단정 금지
- 수치·스펙 나열 최소화
- 이모지/과도한 감탄 표현 금지
- 기획상품은 사실 기반으로만 간단히 언급


========================
연령대/성별 말투 규칙
========================

[10대 여성]
- 밝고 부드럽지만 유행어·반말 금지
- “가볍게 사용하기 좋아요”, “일상에서 부담 없이 사용할 수 있어요”

[20~30대 여성]
- 차분·세련·실용 중심 톤
- “일상 메이크업에 자연스럽게 어울려요”
- “사용감에 대한 만족도가 높아요”

[40대 이상 여성]
- 배려 있고 정중한 톤
- “부담 없이 편안하게 사용하실 수 있어요”

[20~40대 남성]
- 간결·실용 중심 표현
- “일상에서 간편하게 사용하기 좋습니다”
- “깔끔한 사용감을 선호하는 분께 적합합니다”

[10대 남성]
- 심플·직관적 톤
- “가볍게 사용하기 좋습니다”
- “필요한 부분에만 자연스럽게 사용하기 좋습니다”

공통 규칙:
- 존칭 중심 (“~하세요”, “~입니다”)
- 연령·성별을 근거로 성격/취향을 추정하지 말 것
- 사용자의 개인적 가치관/라이프스타일 서술 금지


========================
이름 및 국적 사용 규칙
========================

- 고객 이름은 DB에 저장된 값 그대로 사용하세요.
- 이름을 변환·축약·번역·형태 수정하지 마세요.
- 이름을 근거로 국적/민족/언어를 추정하지 마세요.

- customer["nationality"] 값이 있는 경우:
  • 해당 국적을 고려하여 자연스럽고 존중되는 톤을 사용하세요.
  • 고정관념·문화적 일반화 표현은 사용하지 마세요.

- customer["nationality"] 값이 없거나 비어 있는 경우:
  • 기본 언어는 한국어를 사용합니다.

- 결론 문장에는 다음 형식을 사용하세요:
  "{customer['user_name']} 고객님께 추천드립니다."
  또는
  "{customer['user_name']} 고객님의 일상 루틴에 잘 어울려 추천드립니다."

- 이름은 메시지 내에서 1회만 사용하세요.


========================
출력 형식
========================
- 제품별로 구분해 작성하되,
- 각 제품 내부는 번호·머리글 없이
  자연스러운 단락형 문장으로만 구성하세요.

"""




    print("==================================프롬프트==================================")
    print(prompt)
    print("===========================================================================")
    payload = {"contents":[{"parts":[{"text": prompt}]}]}

    res = requests.post(
        f"{GEMINI_ENDPOINT}?key={GEMINI_API_KEY}",
        headers={"Content-Type": "application/json"},
        json=payload,
    )
    res.raise_for_status()

    return res.json()["candidates"][0]["content"]["parts"][0]["text"]